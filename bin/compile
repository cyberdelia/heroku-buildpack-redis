#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# Configure environment
set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output
# set -x            # enable debugging

# Clean up leaking environment
unset GIT_DIR

# Directories
BUILD_DIR=$1
BUILDPACK_DIR="$(dirname $(dirname $0))"

if ! command -v stunnel4 > /dev/null; then
    echo "!     stunnel not detected! stunnel not supported on heroku-24+"
    echo "!     This buildpack is not required for Redis 6+. Remove this buildpack using:"
    echo "!         $ heroku buildpacks:remove heroku/redis"
    echo "!     And then follow the instructions for using Redis' native TLS support:"
    echo "!     https://devcenter.heroku.com/articles/heroku-redis#security-and-compliance"
    exit 1
fi

echo "-----> Moving the configuration generation script into app/bin"
mkdir -p $BUILD_DIR/bin
cp "$BUILDPACK_DIR/bin/stunnel-conf.sh" $BUILD_DIR/bin/stunnel-conf.sh
chmod +x $BUILD_DIR/bin/stunnel-conf.sh

echo "-----> Moving the start-stunnel script into app/bin"
mkdir -p $BUILD_DIR/bin
cp "$BUILDPACK_DIR/bin/start-stunnel" $BUILD_DIR/bin/
chmod +x $BUILD_DIR/bin/start-stunnel

echo "-----> stunnel done"
